Reed (1979) with Gaussian processes 
========================================================


```{r graphing-options, include=FALSE}
require(pdgControl)
require(nonparametricbayes)
require(reshape2)
require(ggplot2)
library(kernlab)
opts_knit$set(upload.fun = socialR::notebook.url)
opts_chunk$set(dev.args=list(bg="transparent"), comment=NA, tidy=FALSE)
theme_set(theme_bw())
theme_update(panel.background = element_rect(fill = "transparent",colour = NA),
             plot.background = element_rect(fill = "transparent",colour = NA))
```


```{r results="hide"}
knit("beverton_holt_data.Rmd")
true <- data.frame(x = X, y = sapply(X, f, 0, p))
```

Predict the function over the target grid

```{r}
gp <- gp_fit(obs, X, c(sigma_n=2, tau=10, l=8), "conditional")
plot.gpfit(gp, true)
```

Things to do.  
1. Condition f(0) = 0.  [f(x) f[0]]
2. Basis function with linear part $\sigma_1 + \sigma_2 x x' + \sigma_3 e^{\phi (x-x')^2}$
3. higher dimensions


## Stochastic Dynamic programming solution based on the posterior Gaussian process:

```{r}
h_grid <- x_grid
matrices_gp <- gp_transition_matrix(gp)
matrices_true <- f_transition_matrix(f, p, x_grid, h_grid)
opt_true <- find_dp_optim(matrices_true, x_grid, h_grid, 20, 0, profit, delta=.01)
opt_gp <- find_dp_optim(matrices_gp, x_grid, h_grid, 20, 0, profit, delta=.01)
```

```{r policy_plot}
policies <- melt(data.frame(stock=x_grid, GP = x_grid[opt_gp$D[,1]], Exact = x_grid[opt_true$D[,1]]), id="stock")
policy_plot <- ggplot(policies, aes(stock, stock - value, color=variable)) +
  geom_point() + xlab("stock size") + ylab("escapement") 
policy_plot
```

We can see what happens when we attempt to manage a stock using this:

``` {r othernoise}
z_g <- function() rlnorm(1,0, sigma_g)
````

``` {r  simulate }
set.seed(1)
sim_gp <- ForwardSimulate(f, p, x_grid, h_grid, K, opt_gp$D, z_g, profit=profit)
set.seed(1)
sim_true <- ForwardSimulate(f, p, x_grid, h_grid, K, opt_true$D, z_g, profit=profit)
````

``` {r  simplot}
df <- data.frame(time = sim_gp$time, stock_gp = sim_gp$fishstock, stock_true = sim_true$fishstock, harvest_gp = sim_gp$harvest, havest_true = sim_true$harvest)
df <- melt(df, id="time")
simplot <- ggplot(df) + geom_line(aes(time,value, color=variable))
simplot
````

Total Profits

```{r}
sum(sim_gp$profit)
sum(sim_true$profit)
```

